<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produktdetaljer</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/ai.css">
</head>
<body>
  <!----- Header from main goes here ------>
  <header id="header"></header>

  <h1 style="margin-top: 60px;" id="product-name">Laster produkt...</h1>
  <p id="product-description"></p>
  <p id="price">Price: </p>
  <img id="product-image" src="" alt="Produktbilde" style="max-height: 300px; max-width: 300px;">
  <p id='quantity'>Tilgjengelighet: </p>
  

  <form id="formVogn" onsubmit="handleSubmit(event)">
    <label for="">Antall: <input id="antallVogn" type="number" value="1"></label>
    <button type="submit" id="knappVogn">Legg i handlevogn</button>
  </form>

  <!----- chat-box goes here ------>
  <div id="aiDiv"></div>
  </body>

  <script>
    //used to get element from main.html file
      async function loadHTML(id, file, elementId) {
  try {
    const response = await fetch(file);
    if (!response.ok) throw new Error('Feil ved lasting av ' + file);
    const content = await response.text();
    
    // Parse innholdet til et DOM-objekt
    const parser = new DOMParser();
    const doc = parser.parseFromString(content, 'text/html');
    
    // Finn elementet med det spesifikke id-et fra det hentede dokumentet
    const element = doc.getElementById(elementId);
    
    if (element) {
      document.getElementById(id).innerHTML = element.innerHTML;
    } else {
      console.error(`Element med id "${elementId}" ble ikke funnet i ${file}.`);
    }
  } catch (error) {
    console.error(error);
  }
}

  //loads elements from main
  loadHTML('header', 'index.html', 'header');
  loadHTML('aiDiv', 'index.html', 'aiDiv');

    // Gets URL to get right product
  const urlParams = new URLSearchParams(window.location.search);
  const productId = parseInt(urlParams.get("id"), 10);

  async function fetchProduct() {
            try {
                const response = await fetch("http://localhost:3000/products/full");
                const produkter = await response.json();
                
                const produkt = produkter.find(p => p.id === productId);

                visProdukt(produkt);
            } catch (error) {
                console.error("Feil ved henting av produkter:", error);
            }
        }
        document.addEventListener("DOMContentLoaded", fetchProduct);


    function visProdukt(produkt) {
      if (produkt) {
        console.log(produkt);
        
        document.getElementById('product-name').textContent = produkt.productname;
        document.getElementById('product-description').textContent = produkt.description;
        document.getElementById('price').textContent += produkt.price + 'kr';
        document.getElementById('product-image').src = produkt.imageurl;
        formVogn = document.getElementById('formVogn');
        
        if (produkt.quantity == 0) {
          document.getElementById('quantity').textContent += "tomt";
          formVogn.style.display = "none";
        }
        else if(produkt.quantity < 4) {document.getElementById('quantity').textContent += "få igjen";}
        else {document.getElementById('quantity').textContent += "på lager";}

        formVogn.addEventListener('submit', handleSubmit);

      //puts items in shopping cart
      function handleSubmit(event) {
        event.preventDefault();  
        
        let cart = JSON.parse(sessionStorage.getItem('cart')) || [];

        var antall = document.getElementById('antallVogn').value;

        vognProdukt = cart.find(p => p.id === productId);
        if(vognProdukt){
          vognProdukt.antall = parseInt(vognProdukt.antall) + parseInt(antall);
        }
        else{
          let product = {
            id: produkt.id,
            productname: produkt.productname,
            price: produkt.price,
            antall: antall
          };
        
          cart.push(product);  // Puts produkt in shopping cart
        }
        // saves cart
        sessionStorage.setItem('cart', JSON.stringify(cart));

        alert(produkt.productname + " er lagt til i handlekurven!");
      }
    } else {
      document.getElementById('product-name').textContent = "Produkt ikke funnet!";
      document.getElementById('formVogn').style.display = "none";
    }
  }
  </script>
</body>
